flowchart TD
    A["Cliente abre la app y conecta socket"] --> B1["Redis: SADD membership:&lt;channel&gt; &lt;user&gt;"]
    B1 --> B2["Redis: SADD online:&lt;channel&gt; &lt;user&gt;"]
    B2 --> B3["Redis: HSET user_contact:&lt;user&gt;"]
    B3 --> C["Usuario interactúa con el chat"]
    C --> D["Usuario envía mensaje al canal"]
    D --> E["Chat MS publica evento 'new-channel-message' en Redis"]
    E --> F1["Hedwig consume el evento"]
    F1 --> F2["Redis: SDIFF membership:&lt;channel&gt; vs online:&lt;channel&gt;"]
    F2 --> F3["Redis: INCR & EXPIRE para rate-limit por usuario"]
    F3 --> F4["Redis: Pipeline HMGET user_contact:&lt;user&gt;"]
    F4 --> F5["Hedwig envía notificaciones batch (push/email)"]
    B1 --> G["Cliente cierra la app o pierde conexión"]
    G --> H["Redis: SREM online:&lt;channel&gt; &lt;user&gt;"]
